--[[
    Script: WalvyXploit GUI
    Version: 2.2 (Refactored for Readability)
    Author: Walvy
    Description: A modular GUI script with a key system verified via an external web server
                 and logging capabilities through Discord webhooks.
]]

--================================================================--
-- Service and Module Imports
--================================================================--

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")

--================================================================--
-- Configuration
--================================================================--

local CONFIG = {
    -- The endpoint of your web server for key verification.
    VERIFICATION_ENDPOINT = "https://6af326c8-e255-40fb-a584-9c57993e4e7e-00-2228rk1ako92d.picard.replit.dev/verify",

    -- A Discord invitation link displayed in the GUI.
    DISCORD_INVITE_LINK = "https://discord.gg/your-invite-link",

    -- [WARNING] This webhook URL is visible on the client.
    -- For better security, logging should be handled by your web server.
    DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1367725357461147738/cJvQBSyBLV2Ti72fj3lcSQKgZGHb9h4lTu2Tiy-qY-tif7_nF_pLvW6vVX1Wt1fAH5QW",

    -- The name of the GUI object created in the player's interface.
    GUI_NAME = "WalvyXploitGui"
}

--================================================================--
-- Helper Functions
--================================================================--

--- Safely attempts to copy text to the clipboard.
-- @param text string | The text to be copied.
local function safeSetClipboard(text)
    if typeof(setclipboard) == "function" then
        pcall(setclipboard, text)
    else
        warn("WalvyXploit: 'setclipboard' is not available in this environment.")
    end
end

--- Creates and parents a UICorner element.
-- @param parent Instance | The instance to which the corner will be applied.
-- @param radius number | The radius of the corner.
local function createCorner(parent, radius)
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, radius)
    corner.Parent = parent
end

--================================================================--
-- Main Application Module
--================================================================--

local App = {}
App.__index = App

--- Initializes the application, creating the GUI and setting up events.
function App.new()
    local self = setmetatable({}, App)

    self.lastActiveMenu = nil
    self.isVerifying = false
    self.localPlayer = Players.LocalPlayer

    if not self.localPlayer then
        warn("WalvyXploit: Could not find LocalPlayer. Aborting script.")
        return nil
    end

    local playerGui = self.localPlayer:WaitForChild("PlayerGui")
    if not playerGui then
        warn("WalvyXploit: Could not find PlayerGui. Aborting script.")
        return nil
    end

    self.screenGui = Instance.new("ScreenGui")
    self.screenGui.Name = CONFIG.GUI_NAME
    self.screenGui.ResetOnSpawn = false
    self.screenGui.Parent = playerGui

    self:_setupUI()

    print("WalvyXploit GUI Loaded (v2.2).")
    return self
end

--- Creates and connects all UI elements.
function App:_setupUI()
    local keySystem = self:_createKeySystem()
    local menuSelection = self:_createMenuSelection()
    local discordBanner = self:_createDiscordBanner()
    local reopenButton = self:_createReopenButton()

    local function showMainMenu()
        keySystem.frame:Destroy()
        menuSelection.frame.Visible = true
        discordBanner.frame.Visible = true
    end

    -- Connect Events
    keySystem.submit.MouseButton1Click:Connect(function()
        if self.isVerifying then return end
        self.isVerifying = true
        self:_onKeySubmit(keySystem.input.Text, keySystem.status, showMainMenu)
        task.wait(1) -- Debounce to prevent spam
        self.isVerifying = false
    end)

    menuSelection.freeButton.MouseButton1Click:Connect(function()
        menuSelection.frame:Destroy()
        discordBanner.frame:Destroy()
        self.lastActiveMenu = self:_createMenuBase("Free Menu", reopenButton)
    end)

    menuSelection.premiumButton.MouseButton1Click:Connect(function()
        menuSelection.frame:Destroy()
        discordBanner.frame:Destroy()
        self.lastActiveMenu = self:_createMenuBase("Premium Menu", reopenButton)
    end)

    discordBanner.link.MouseButton1Click:Connect(function()
        safeSetClipboard(CONFIG.DISCORD_INVITE_LINK)
        discordBanner.frame:Destroy()
    end)

    reopenButton.MouseButton1Click:Connect(function()
        if self.lastActiveMenu and self.lastActiveMenu.Parent then
            self.lastActiveMenu.Visible = true
        end
        reopenButton.Visible = false
    end)
end

--- Handles the key submission and verification process.
-- @param key string | The key entered by the user.
-- @param statusLabel TextLabel | The label used to display status messages.
-- @param successCallback function | The function to call upon successful verification.
function App:_onKeySubmit(key, statusLabel, successCallback)
    if not key or key:gsub("%s", "") == "" then
        statusLabel.Text = "Please enter a key."
        return
    end

    statusLabel.Text = "Verifying key..."

    local requestUrl = string.format("%s?key=%s&userId=%s", CONFIG.VERIFICATION_ENDPOINT, key, tostring(self.localPlayer.UserId))

    local success, responseBody = pcall(function()
        return HttpService:GetAsync(requestUrl)
    end)

    if not success then
        statusLabel.Text = "Error: Server unreachable."
        warn("WalvyXploit: HTTP request failed. Error: ", tostring(responseBody))
        return
    end

    local responseData
    local decodeSuccess, decodedJson = pcall(function()
        responseData = HttpService:JSONDecode(responseBody)
    end)

    if not decodeSuccess then
        statusLabel.Text = "Error: Invalid server response."
        warn("WalvyXploit: Failed to decode JSON response. Body: ", responseBody)
        return
    end

    if responseData and responseData.status == "success" then
        statusLabel.Text = "Key accepted! Opening menu..."
        self:_sendSuccessWebhook(key)
        task.wait(1)
        successCallback()
    else
        statusLabel.Text = responseData.message or "Invalid key."
    end
end

--- Sends a log message to the configured Discord webhook.
-- @param keyUsed string | The key that was successfully used.
function App:_sendSuccessWebhook(keyUsed)
    if not CONFIG.DISCORD_WEBHOOK_URL or CONFIG.DISCORD_WEBHOOK_URL == "" then
        return
    end

    local payload = {
        username = "WalvyXploit Logger",
        avatar_url = "https://i.imgur.com/glaA21A.png",
        embeds = {{
            title = "Key Activation Successful",
            color = 65280, -- Green
            fields = {
                {name = "Player", value = string.format("`%s`", self.localPlayer.Name), inline = true},
                {name = "UserID", value = tostring(self.localPlayer.UserId), inline = true},
                {name = "Key Used", value = string.format("||`%s`||", keyUsed)} -- Spoiler tag for key
            },
            footer = {text = "WalvyXploit | " .. os.date("!*t")}
        }}
    }

    local success, err = pcall(function()
        HttpService:PostAsync(CONFIG.DISCORD_WEBHOOK_URL, HttpService:JSONEncode(payload))
    end)

    if not success then
        warn("WalvyXploit: Failed to send Discord webhook. Error: ", tostring(err))
    end
end

--================================================================--
-- GUI Component Creation Methods
--================================================================--

--- Creates the key submission window.
function App:_createKeySystem()
    local keyFrame = Instance.new("Frame"); keyFrame.Name = "KeyFrame"; keyFrame.AnchorPoint = Vector2.new(0.5, 0.5); keyFrame.Size = UDim2.new(0, 300, 0, 180); keyFrame.Position = UDim2.new(0.5, 0, 0.5, 0); keyFrame.BackgroundColor3 = Color3.fromRGB(25, 28, 41); keyFrame.Parent = self.screenGui; createCorner(keyFrame, 8)
    local title = Instance.new("TextLabel"); title.Name = "Title"; title.Size = UDim2.new(1, 0, 0, 30); title.Text = "Enter Key"; title.TextColor3 = Color3.fromRGB(255, 255, 255); title.Font = Enum.Font.SourceSansBold; title.TextSize = 18; title.BackgroundTransparency = 1; title.Parent = keyFrame
    local input = Instance.new("TextBox"); input.Name = "Input"; input.Size = UDim2.new(0, 260, 0, 40); input.Position = UDim2.new(0.5, -130, 0, 40); input.PlaceholderText = "Your Key"; input.Font = Enum.Font.SourceSans; input.TextSize = 16; input.Parent = keyFrame
    local status = Instance.new("TextLabel"); status.Name = "Status"; status.Size = UDim2.new(1, -40, 0, 20); status.Position = UDim2.new(0.5, 0, 0, 85); status.AnchorPoint = Vector2.new(0.5, 0); status.Text = ""; status.Font = Enum.Font.SourceSans; status.TextSize = 14; status.TextColor3 = Color3.fromRGB(255, 80, 80); status.BackgroundTransparency = 1; status.Parent = keyFrame
    local submit = Instance.new("TextButton"); submit.Name = "Submit"; submit.Size = UDim2.new(0, 100, 0, 40); submit.Position = UDim2.new(0.5, -50, 0, 115); submit.Text = "Submit"; submit.Font = Enum.Font.SourceSansBold; submit.TextSize = 18; submit.BackgroundColor3 = Color3.fromRGB(50, 58, 82); submit.TextColor3 = Color3.fromRGB(255, 255, 255); submit.Parent = keyFrame; createCorner(submit, 8)
    return {frame = keyFrame, input = input, submit = submit, status = status}
end

--- Creates the menu selection window.
function App:_createMenuSelection()
    local selectionFrame = Instance.new("Frame"); selectionFrame.Name = "SelectionFrame"; selectionFrame.AnchorPoint = Vector2.new(0.5, 0.5); selectionFrame.Size = UDim2.new(0, 300, 0, 150); selectionFrame.Position = UDim2.new(0.5, 0, 0.5, 0); selectionFrame.BackgroundColor3 = Color3.fromRGB(25, 28, 41); selectionFrame.Visible = false; selectionFrame.Parent = self.screenGui; createCorner(selectionFrame, 8)
    local title = Instance.new("TextLabel"); title.Name = "Title"; title.Size = UDim2.new(1, 0, 0, 30); title.Text = "Select Menu"; title.TextColor3 = Color3.fromRGB(255, 255, 255); title.Font = Enum.Font.SourceSansBold; title.TextSize = 18; title.BackgroundTransparency = 1; title.Parent = selectionFrame
    local freeButton = Instance.new("TextButton"); freeButton.Name = "FreeButton"; freeButton.Size = UDim2.new(0, 120, 0, 50); freeButton.Position = UDim2.new(0.5, -130, 0.5, -25); freeButton.Text = "Free Menu"; freeButton.Font = Enum.Font.SourceSansBold; freeButton.TextSize = 18; freeButton.BackgroundColor3 = Color3.fromRGB(50, 58, 82); freeButton.TextColor3 = Color3.fromRGB(255, 255, 255); freeButton.Parent = selectionFrame; createCorner(freeButton, 8)
    local premiumButton = Instance.new("TextButton"); premiumButton.Name = "PremiumButton"; premiumButton.Size = UDim2.new(0, 120, 0, 50); premiumButton.Position = UDim2.new(0.5, 10, 0.5, -25); premiumButton.Text = "Premium Menu"; premiumButton.Font = Enum.Font.SourceSansBold; premiumButton.TextSize = 18; premiumButton.BackgroundColor3 = Color3.fromRGB(255, 215, 0); premiumButton.TextColor3 = Color3.fromRGB(0, 0, 0); premiumButton.Parent = selectionFrame; createCorner(premiumButton, 8)
    return {frame = selectionFrame, freeButton = freeButton, premiumButton = premiumButton}
end

--- Creates the Discord notification banner.
function App:_createDiscordBanner()
    local discordFrame = Instance.new("Frame"); discordFrame.Name = "DiscordNotification"; discordFrame.AnchorPoint = Vector2.new(0.5, 0); discordFrame.Size = UDim2.new(0, 300, 0, 60); discordFrame.Position = UDim2.new(0.5, 0, 0, 10); discordFrame.BackgroundColor3 = Color3.fromRGB(25, 28, 41); discordFrame.Visible = false; discordFrame.Parent = self.screenGui; createCorner(discordFrame, 8)
    local title = Instance.new("TextLabel"); title.Size = UDim2.new(1, 0, 0.5, 0); title.Text = "Join our Discord!"; title.TextColor3 = Color3.fromRGB(255, 255, 255); title.Font = Enum.Font.SourceSansBold; title.TextSize = 18; title.BackgroundTransparency = 1; title.Parent = discordFrame
    local link = Instance.new("TextButton"); link.Size = UDim2.new(0, 200, 0, 30); link.Position = UDim2.new(0.5, -100, 0.5, 0); link.Text = "Click to copy link"; link.Font = Enum.Font.SourceSans; link.TextSize = 16; link.BackgroundColor3 = Color3.fromRGB(88, 101, 242); link.TextColor3 = Color3.fromRGB(255, 255, 255); link.Parent = discordFrame; createCorner(link, 8)
    return {frame = discordFrame, link = link}
end

--- Creates the button to reopen a minimized menu.
function App:_createReopenButton()
    local reopenBtn = Instance.new("TextButton"); reopenBtn.Name = "ReopenButton"; reopenBtn.AnchorPoint = Vector2.new(0.5, 0); reopenBtn.Size = UDim2.new(0, 150, 0, 50); reopenBtn.Position = UDim2.new(0.5, 0, 0, 5); reopenBtn.Text = "Open Menu"; reopenBtn.Font = Enum.Font.SourceSansBold; reopenBtn.TextSize = 16; reopenBtn.BackgroundColor3 = Color3.fromRGB(50, 58, 82); reopenBtn.TextColor3 = Color3.fromRGB(255, 255, 255); reopenBtn.Visible = false; reopenBtn.Parent = self.screenGui; createCorner(reopenBtn, 8)
    return reopenBtn
end

--- Creates the base draggable menu window.
function App:_createMenuBase(title, reopenButton)
    local menuFrame = Instance.new("Frame"); menuFrame.Name = title:gsub("%s", "") .. "Frame"; menuFrame.AnchorPoint = Vector2.new(0.5, 0.5); menuFrame.Size = UDim2.new(0, 600, 0, 500); menuFrame.Position = UDim2.new(0.5, 0, 0.5, 0); menuFrame.BackgroundColor3 = Color3.fromRGB(25, 28, 41); menuFrame.Draggable = true; menuFrame.Active = true; menuFrame.Parent = self.screenGui; createCorner(menuFrame, 8)
    local titleBar = Instance.new("Frame"); titleBar.Name = "TitleBar"; titleBar.Size = UDim2.new(1, 0, 0, 30); titleBar.BackgroundColor3 = Color3.fromRGB(35, 38, 51); titleBar.Parent = menuFrame; createCorner(titleBar, 8)
    local titleLabel = Instance.new("TextLabel"); titleLabel.Name = "TitleLabel"; titleLabel.Size = UDim2.new(1, -60, 1, 0); titleLabel.Position = UDim2.new(0, 10, 0, 0); titleLabel.Text = title; titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255); titleLabel.Font = Enum.Font.SourceSansBold; titleLabel.TextSize = 18; titleLabel.TextXAlignment = Enum.TextXAlignment.Left; titleLabel.Parent = titleBar
    local minimize = Instance.new("TextButton"); minimize.Name = "MinimizeButton"; minimize.Size = UDim2.new(0, 30, 1, 0); minimize.Position = UDim2.new(1, -60, 0, 0); minimize.Text = "—"; minimize.TextColor3 = Color3.fromRGB(255, 255, 255); minimize.BackgroundColor3 = titleBar.BackgroundColor3; minimize.Font = Enum.Font.SourceSansBold; minimize.TextSize = 24; minimize.Parent = titleBar; createCorner(minimize, 8)
    local close = Instance.new("TextButton"); close.Name = "CloseButton"; close.Size = UDim2.new(0, 30, 1, 0); close.Position = UDim2.new(1, -30, 0, 0); close.Text = "✕"; close.TextColor3 = Color3.fromRGB(255, 255, 255); close.BackgroundColor3 = Color3.fromRGB(180, 0, 0); close.Font = Enum.Font.SourceSansBold; close.TextSize = 20; close.Parent = titleBar; createCorner(close, 8)

    minimize.MouseButton1Click:Connect(function()
        menuFrame.Visible = false
        if reopenButton then reopenButton.Visible = true end
    end)
    close.MouseButton1Click:Connect(function()
        self.screenGui:Destroy()
    end)

    return menuFrame
end

--================================================================--
-- Script Entry Point
--================================================================--

-- Run the entire script in a protected call to prevent it from breaking other scripts.
pcall(function()
    App.new()
end)
