--[[
    Script: WalvyXploit GUI with Timed Key System
    Description: A Roblox GUI script featuring a key system that allows access for 8 hours per key activation.
    Author: Walvy
    Version: 1.2 (Added 8-hour key validation)
]]

--================================================================--
-- Services and Variables
--================================================================--

local Players = game:GetService("Players")
local DataStoreService = game:GetService("DataStoreService")
local localPlayer = Players.LocalPlayer
local playerGui = localPlayer:WaitForChild("PlayerGui")

-- Get a DataStore to save the key activation time
local keyTimeStore = DataStoreService:GetDataStore("KeyActivationTimeStore")

-- Configuration
local CORRECT_KEY = "WalvyKey"
local DISCORD_INVITE_LINK = "https://discord.gg/your-invite-link"
local KEY_VALID_DURATION = 28800 -- 8 hours in seconds (8 * 60 * 60)

-- State Variables
local lastActiveMenu = nil

--================================================================--
-- GUI Creation
--================================================================--

-- Main container for all GUI elements
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "MyGui"
screenGui.Parent = playerGui

--- A utility function to create a UI Corner element.
local function createCorner(parent, radius)
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, radius)
    corner.Parent = parent
    return corner
end

--- Creates the Key System window.
local function createKeySystemFrame()
    local keyFrame = Instance.new("Frame")
    keyFrame.Name = "KeyFrame"
    keyFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    keyFrame.Size = UDim2.new(0, 300, 0, 180) -- Increased height for status message
    keyFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    keyFrame.BackgroundColor3 = Color3.fromRGB(25, 28, 41)
    keyFrame.BorderSizePixel = 0
    keyFrame.Parent = screenGui
    createCorner(keyFrame, 8)

    local keyTitle = Instance.new("TextLabel")
    keyTitle.Name = "KeyTitle"
    keyTitle.Size = UDim2.new(1, 0, 0, 30)
    keyTitle.Text = "Enter Key"
    keyTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    keyTitle.Font = Enum.Font.SourceSansBold
    keyTitle.TextSize = 18
    keyTitle.BackgroundTransparency = 1
    keyTitle.Parent = keyFrame

    local keyInput = Instance.new("TextBox")
    keyInput.Name = "KeyInput"
    keyInput.Size = UDim2.new(0, 260, 0, 40)
    keyInput.Position = UDim2.new(0.5, -130, 0, 40)
    keyInput.PlaceholderText = "Your Key"
    keyInput.Font = Enum.Font.SourceSans
    keyInput.TextSize = 16
    keyInput.Parent = keyFrame

    local statusLabel = Instance.new("TextLabel")
    statusLabel.Name = "StatusLabel"
    statusLabel.Size = UDim2.new(1, -40, 0, 20)
    statusLabel.Position = UDim2.new(0.5, 0, 0, 85)
    statusLabel.AnchorPoint = Vector2.new(0.5, 0)
    statusLabel.Text = ""
    statusLabel.Font = Enum.Font.SourceSans
    statusLabel.TextSize = 14
    statusLabel.TextColor3 = Color3.fromRGB(255, 80, 80) -- Red for errors
    statusLabel.BackgroundTransparency = 1
    statusLabel.Parent = keyFrame

    local submitKeyButton = Instance.new("TextButton")
    submitKeyButton.Name = "SubmitKeyButton"
    submitKeyButton.Size = UDim2.new(0, 100, 0, 40)
    submitKeyButton.Position = UDim2.new(0.5, -50, 0, 115)
    submitKeyButton.Text = "Submit"
    submitKeyButton.Font = Enum.Font.SourceSansBold
    submitKeyButton.TextSize = 18
    submitKeyButton.BackgroundColor3 = Color3.fromRGB(50, 58, 82)
    submitKeyButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    submitKeyButton.Parent = keyFrame
    createCorner(submitKeyButton, 8)

    return keyFrame, keyInput, submitKeyButton, statusLabel
end

--- Creates the Menu Selection window.
local function createMenuSelectionFrame()
    local selectionFrame = Instance.new("Frame")
    selectionFrame.Name = "SelectionFrame"
    selectionFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    selectionFrame.Size = UDim2.new(0, 300, 0, 150)
    selectionFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    selectionFrame.BackgroundColor3 = Color3.fromRGB(25, 28, 41)
    selectionFrame.BorderSizePixel = 0
    selectionFrame.Visible = false
    selectionFrame.Parent = screenGui
    createCorner(selectionFrame, 8)

    local selectionTitle = Instance.new("TextLabel")
    selectionTitle.Name = "SelectionTitle"
    selectionTitle.Size = UDim2.new(1, 0, 0, 30)
    selectionTitle.Text = "Select Menu"
    selectionTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    selectionTitle.Font = Enum.Font.SourceSansBold
    selectionTitle.TextSize = 18
    selectionTitle.BackgroundTransparency = 1
    selectionTitle.Parent = selectionFrame

    local freeMenuButton = Instance.new("TextButton")
    freeMenuButton.Name = "FreeMenuButton"
    freeMenuButton.Size = UDim2.new(0, 120, 0, 50)
    freeMenuButton.Position = UDim2.new(0.5, -130, 0.5, -25)
    freeMenuButton.Text = "Free Menu"
    freeMenuButton.Font = Enum.Font.SourceSansBold
    freeMenuButton.TextSize = 18
    freeMenuButton.BackgroundColor3 = Color3.fromRGB(50, 58, 82)
    freeMenuButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    freeMenuButton.Parent = selectionFrame
    createCorner(freeMenuButton, 8)

    local premiumMenuButton = Instance.new("TextButton")
    premiumMenuButton.Name = "PremiumMenuButton"
    premiumMenuButton.Size = UDim2.new(0, 120, 0, 50)
    premiumMenuButton.Position = UDim2.new(0.5, 10, 0.5, -25)
    premiumMenuButton.Text = "Premium Menu"
    premiumMenuButton.Font = Enum.Font.SourceSansBold
    premiumMenuButton.TextSize = 18
    premiumMenuButton.BackgroundColor3 = Color3.fromRGB(255, 215, 0)
    premiumMenuButton.TextColor3 = Color3.fromRGB(0, 0, 0)
    premiumMenuButton.Parent = selectionFrame
    createCorner(premiumMenuButton, 8)

    return selectionFrame, freeMenuButton, premiumMenuButton
end

--- Creates the Discord Notification banner.
local function createDiscordNotification()
    local discordFrame = Instance.new("Frame")
    discordFrame.Name = "DiscordNotification"
    discordFrame.AnchorPoint = Vector2.new(0.5, 0)
    discordFrame.Size = UDim2.new(0, 300, 0, 60)
    discordFrame.Position = UDim2.new(0.5, 0, 0, 10)
    discordFrame.BackgroundColor3 = Color3.fromRGB(25, 28, 41)
    discordFrame.Visible = false
    discordFrame.Parent = screenGui
    createCorner(discordFrame, 8)

    local discordTitle = Instance.new("TextLabel")
    discordTitle.Size = UDim2.new(1, 0, 0.5, 0)
    discordTitle.Text = "Join our Discord!"
    discordTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    discordTitle.Font = Enum.Font.SourceSansBold
    discordTitle.TextSize = 18
    discordTitle.BackgroundTransparency = 1
    discordTitle.Parent = discordFrame

    local discordLink = Instance.new("TextButton")
    discordLink.Size = UDim2.new(0, 200, 0, 30)
    discordLink.Position = UDim2.new(0.5, -100, 0.5, 0)
    discordLink.Text = "Click to copy link"
    discordLink.Font = Enum.Font.SourceSans
    discordLink.TextSize = 16
    discordLink.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
    discordLink.TextColor3 = Color3.fromRGB(255, 255, 255)
    discordLink.Parent = discordFrame
    createCorner(discordLink, 8)

    return discordFrame, discordLink
end

--- Creates the button to reopen a minimized menu.
local function createReopenButton()
    local reopenButton = Instance.new("TextButton")
    reopenButton.Name = "ReopenButton"
    reopenButton.AnchorPoint = Vector2.new(0.5, 0)
    reopenButton.Size = UDim2.new(0, 150, 0, 50)
    reopenButton.Position = UDim2.new(0.5, 0, 0, 5)
    reopenButton.Text = "Open Menu"
    reopenButton.Font = Enum.Font.SourceSansBold
    reopenButton.TextSize = 16
    reopenButton.BackgroundColor3 = Color3.fromRGB(50, 58, 82)
    reopenButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    reopenButton.Visible = false
    reopenButton.Parent = screenGui
    createCorner(reopenButton, 8)
    return reopenButton
end

--- Creates the base structure for a draggable menu window.
local function createBaseMenu(title)
    local menuFrame = Instance.new("Frame")
    menuFrame.Name = title:gsub(" ", "") .. "Frame"
    menuFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    menuFrame.Size = UDim2.new(0, 600, 0, 500)
    menuFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    menuFrame.BackgroundColor3 = Color3.fromRGB(25, 28, 41)
    menuFrame.BorderSizePixel = 0
    menuFrame.Draggable = true
    menuFrame.Active = true
    menuFrame.Visible = true
    menuFrame.Parent = screenGui
    createCorner(menuFrame, 8)

    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 30)
    titleBar.BackgroundColor3 = Color3.fromRGB(35, 38, 51)
    titleBar.BorderSizePixel = 0
    titleBar.Parent = menuFrame
    createCorner(titleBar, 8)

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Name = "TitleLabel"
    titleLabel.Size = UDim2.new(1, -60, 1, 0)
    titleLabel.Position = UDim2.new(0, 10, 0, 0)
    titleLabel.Text = title
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.Font = Enum.Font.SourceSansBold
    titleLabel.TextSize = 18
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = titleBar

    local minimizeButton = Instance.new("TextButton")
    minimizeButton.Name = "MinimizeButton"
    minimizeButton.Size = UDim2.new(0, 30, 1, 0)
    minimizeButton.Position = UDim2.new(1, -60, 0, 0)
    minimizeButton.Text = "—"
    minimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    minimizeButton.BackgroundColor3 = Color3.fromRGB(35, 38, 51)
    minimizeButton.Font = Enum.Font.SourceSansBold
    minimizeButton.TextSize = 24
    minimizeButton.Parent = titleBar
    createCorner(minimizeButton, 8)

    local closeButton = Instance.new("TextButton")
    closeButton.Name = "CloseButton"
    closeButton.Size = UDim2.new(0, 30, 1, 0)
    closeButton.Position = UDim2.new(1, -30, 0, 0)
    closeButton.Text = "✕"
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.BackgroundColor3 = Color3.fromRGB(180, 0, 0)
    closeButton.Font = Enum.Font.SourceSansBold
    closeButton.TextSize = 20
    closeButton.Parent = titleBar
    createCorner(closeButton, 8)

    minimizeButton.MouseButton1Click:Connect(function()
        menuFrame.Visible = false
        reopenButton.Visible = true
    end)

    closeButton.MouseButton1Click:Connect(function()
        screenGui:Destroy()
    end)

    return menuFrame
end

--================================================================--
-- Key Validation and Main Logic
--================================================================--

local keyFrame, keyInput, submitKeyButton, statusLabel = createKeySystemFrame()
local selectionFrame, freeMenuButton, premiumMenuButton = createMenuSelectionFrame()
local discordNotification, discordLink = createDiscordNotification()
local reopenButton = createReopenButton()

local function openMenu()
    keyFrame:Destroy()
    selectionFrame.Visible = true
    discordNotification.Visible = true
end

local function checkKeyValidity()
    local success, activationTime = pcall(function()
        return keyTimeStore:GetAsync(localPlayer.UserId .. "_" .. CORRECT_KEY)
    end)

    if success and activationTime then
        local timeSinceActivation = tick() - activationTime
        if timeSinceActivation < KEY_VALID_DURATION then
            -- Key is still valid, open the menu directly
            openMenu()
            return
        else
            -- Key has expired, remove the old entry
            pcall(function()
                keyTimeStore:RemoveAsync(localPlayer.UserId .. "_" .. CORRECT_KEY)
            end)
        end
    end
    -- If no valid key session, the key prompt remains visible
end

-- --- Event Handlers ---

submitKeyButton.MouseButton1Click:Connect(function()
    if keyInput.Text ~= CORRECT_KEY then
        statusLabel.Text = "Incorrect Key"
        return
    end

    statusLabel.Text = "Checking key..."

    local success, activationTime = pcall(function()
        return keyTimeStore:GetAsync(localPlayer.UserId .. "_" .. CORRECT_KEY)
    end)

    if not success then
        statusLabel.Text = "Error: Could not verify key. Try again."
        return
    end

    local currentTime = tick()
    if activationTime and (currentTime - activationTime < KEY_VALID_DURATION) then
        -- Key is already active and valid
        statusLabel.Text = "Key session active. Opening menu..."
        wait(1)
        openMenu()
    else
        -- New key activation
        local setSuccess, err = pcall(function()
            keyTimeStore:SetAsync(localPlayer.UserId .. "_" .. CORRECT_KEY, currentTime)
        end)
        if setSuccess then
            statusLabel.Text = "Key activated! Opening menu..."
            wait(1)
            openMenu()
        else
            statusLabel.Text = "Error: Could not save key. Try again."
        end
    end
end)

freeMenuButton.MouseButton1Click:Connect(function()
    selectionFrame:Destroy()
    local freeMenu = createBaseMenu("Free Menu")
    lastActiveMenu = freeMenu
end)

premiumMenuButton.MouseButton1Click:Connect(function()
    selectionFrame:Destroy()
    local premiumMenu = createBaseMenu("Premium Menu")
    lastActiveMenu = premiumMenu
end)

reopenButton.MouseButton1Click:Connect(function()
    if lastActiveMenu then
        lastActiveMenu.Visible = true
    end
    reopenButton.Visible = false
end)

discordLink.MouseButton1Click:Connect(function()
    if setclipboard then
        setclipboard(DISCORD_INVITE_LINK)
    end
    discordNotification:Destroy()
end)

-- On script start, check if there's already a valid key session
checkKeyValidity()

print("WalvyXploit GUI with Timed Key Loaded.")
